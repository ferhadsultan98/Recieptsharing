
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sweet & Savory Corner</title>
    <style>
        /* Global Resets and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #FFF0F5; /* Lavender Blush - main background */
            color: #5D5D5D; /* Dark Gray - primary text color */
            line-height: 1.6;
            font-size: 16px;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Georgia', 'Times New Roman', Times, serif; /* Elegant font for headings */
            color: #FF69B4; /* Deep Pink - heading color */
            margin-bottom: 0.75em;
            line-height: 1.2;
        }

        p {
            margin-bottom: 1em;
        }

        a {
            color: #FF69B4; /* Deep Pink */
            text-decoration: none;
            transition: color 0.3s ease;
        }

        a:hover {
            color: #FF1493; /* Darker Pink */
        }

        img, video {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
        }

        button, input[type="submit"] {
            background-color: #FFC0CB; /* Pink */
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px; /* Rounded buttons */
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        button:hover, input[type="submit"]:hover {
            background-color: #FFB6C1; /* Light Pink */
            transform: translateY(-2px);
        }
        
        button:active, input[type="submit"]:active {
            transform: translateY(0);
        }

        input[type="text"],
        input[type="email"],
        input[type="url"],
        textarea,
        select {
            width: 100%;
            padding: 10px 15px;
            margin-bottom: 15px;
            border: 1px solid #D8BFD8; /* Thistle */
            border-radius: 8px;
            font-size: 0.95em;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="url"]:focus,
        textarea:focus,
        select:focus {
            border-color: #FFB6C1; /* Light Pink */
            box-shadow: 0 0 5px rgba(255, 182, 193, 0.5);
            outline: none;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .container {
            width: 90%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px 0;
        }

        /* Navigation Header */
        .navbar {
            background-color: #FFFFFF;
            padding: 15px 0;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            transition: top 0.3s ease;
        }

        .navbar-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 90%;
            max-width: 1200px;
            margin: 0 auto;
        }

        .site-logo {
            font-size: 1.8em;
            font-weight: bold;
            font-family: 'Georgia', 'Times New Roman', Times, serif;
            color: #FF69B4;
        }
        .site-logo a { color: inherit; text-decoration: none; }

        .nav-links {
            list-style: none;
            display: flex;
        }

        .nav-links li {
            margin-left: 25px;
        }

        .nav-links a {
            font-weight: 500;
            font-size: 1em;
            padding: 5px 0;
            position: relative;
        }
        .nav-links a::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 0;
            height: 2px;
            background-color: #FF69B4;
            transition: width 0.3s ease;
        }
        .nav-links a:hover::after {
            width: 100%;
        }

        .profile-icon, .menu-toggle {
            font-size: 1.5em;
            cursor: pointer;
            background: none;
            border: none;
            color: #FF69B4;
            padding: 5px;
        }
        .menu-toggle { display: none; }


        /* Main Content Area */
        main {
            padding-top: 100px; /* Adjust based on navbar height */
            min-height: calc(100vh - 150px); /* Footer height approx 50px + padding */
        }

        /* Recipe Gallery */
        #recipe-gallery-section {
            padding: 20px 0;
        }
        
        .gallery-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .search-bar input[type="text"] {
            padding: 10px 15px;
            width: 250px;
            max-width: 100%;
            border-radius: 20px;
            margin-bottom: 0;
        }
        
        .filter-sort select {
            padding: 10px 15px;
            border-radius: 20px;
            margin-bottom: 0;
            background-color: white;
        }

        .recipe-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
        }

        .recipe-card {
            background-color: #FFFFFF;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .recipe-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }

        .recipe-card-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .recipe-card-content {
            padding: 20px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .recipe-card-content h3 {
            font-size: 1.4em;
            margin-bottom: 10px;
        }

        .recipe-card-content p {
            font-size: 0.9em;
            margin-bottom: 15px;
            flex-grow: 1;
            color: #777;
        }
        
        .recipe-card-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85em;
            color: #888;
            margin-bottom: 15px;
        }

        .recipe-card-meta .likes {
            cursor: pointer;
        }
        .recipe-card-meta .likes.liked svg path {
            fill: #FF69B4;
            stroke: #FF69B4;
        }
        .recipe-card-meta .likes svg {
            width: 18px;
            height: 18px;
            vertical-align: middle;
            margin-right: 5px;
            transition: fill 0.3s ease, stroke 0.3s ease;
        }
         .recipe-card-meta .likes svg path {
            fill: none;
            stroke: #FF69B4;
            stroke-width: 1.5px;
        }


        /* Modals */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5); /* Dim background */
            animation: fadeIn 0.3s ease-out;
        }

        .modal-content {
            background-color: #FFFAFA; /* Snow - slightly off-white */
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px; /* Default max-width */
            position: relative;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            animation: slideIn 0.4s ease-out;
        }
        .modal-content.modal-lg {
            max-width: 800px;
        }


        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }


        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 15px;
            right: 25px;
            transition: color 0.3s ease;
        }

        .close-btn:hover,
        .close-btn:focus {
            color: #FF69B4;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-header h2 {
            margin-top: 0;
            margin-bottom: 20px;
        }
        
        /* Add Recipe Form & Edit Form*/
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #FF69B4;
        }
        #image-preview {
            max-width: 200px;
            max-height: 200px;
            margin-top: 10px;
            border: 1px solid #D8BFD8;
            border-radius: 8px;
            display: none; /* Hidden until image selected */
        }
        
        /* Recipe Detail View */
        #recipe-detail-modal .modal-content {
            max-height: 85vh;
            overflow-y: auto;
        }
        .recipe-detail-media {
            width: 100%;
            max-height: 400px;
            object-fit: cover;
            margin-bottom: 20px;
        }
        .recipe-detail-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }
        .recipe-detail-actions .like-btn.liked {
             background-color: #FFB6C1;
        }
        .recipe-detail-actions .like-btn.liked svg path{
            fill: white;
        }
        .recipe-detail-actions .like-btn svg {
            width: 16px; height: 16px; margin-right: 8px; vertical-align: middle;
        }
        .recipe-detail-actions .like-btn svg path {
            fill: white;
        }

        /* Comment Section */
        .comments-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #D8BFD8;
        }
        .comment {
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .comment-author {
            font-weight: bold;
            color: #FF69B4;
        }
        .comment-date {
            font-size: 0.8em;
            color: #999;
        }
        .comment-body {
            margin-bottom: 10px;
        }
        .comment-actions button {
            background: none;
            border: none;
            color: #FF69B4;
            font-size: 0.85em;
            padding: 2px 5px;
            cursor: pointer;
            margin-right: 10px;
        }
        .comment-actions button:hover {
            text-decoration: underline;
        }
        .replies {
            margin-left: 30px;
            padding-left: 15px;
            border-left: 2px solid #FFD1DC; /* Pale Pink */
        }
        .reply-form, .edit-comment-form {
            margin-top: 10px;
            margin-bottom: 10px;
        }
        .reply-form textarea, .edit-comment-form textarea {
            min-height: 60px;
            margin-bottom: 8px;
        }

        /* Footer */
        .footer {
            background-color: #FFFAFA; /* Snow */
            color: #888;
            text-align: center;
            padding: 25px 0;
            border-top: 1px solid #D8BFD8; /* Thistle */
            margin-top: 40px;
        }
        .footer p { margin-bottom: 10px; }
        .social-media-placeholders a {
            margin: 0 10px;
            font-size: 1.5em;
            color: #FFC0CB; /* Pink */
        }
        .social-media-placeholders a:hover {
            color: #FFB6C1; /* Light Pink */
        }
        .newsletter-form input[type="email"]{
            width: 250px;
            padding: 10px;
            border-radius: 20px;
            border: 1px solid #D8BFD8;
            margin-right: 5px;
            display: inline-block;
            vertical-align: middle;
        }
         .newsletter-form button {
            padding: 10px 15px;
            vertical-align: middle;
        }

        /* Scroll-to-top Button */
        #scroll-to-top {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #FFC0CB; /* Pink */
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            cursor: pointer;
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: background-color 0.3s ease, opacity 0.3s ease, visibility 0.3s ease;
        }
        #scroll-to-top:hover {
            background-color: #FFB6C1; /* Light Pink */
        }
        
        /* Utility Classes */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .mt-1 { margin-top: 1rem; }
        .mb-1 { margin-bottom: 1rem; }

        /* Responsive Design */
        @media (max-width: 768px) {
            .navbar-container {
                width: 95%;
            }
            .nav-links {
                display: none;
                flex-direction: column;
                position: absolute;
                top: 70px; /* Below navbar */
                left: 0;
                width: 100%;
                background-color: #FFFFFF;
                box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                padding: 10px 0;
            }
            .nav-links.active {
                display: flex;
            }
            .nav-links li {
                margin: 10px 20px;
                text-align: center;
            }
            .menu-toggle {
                display: block;
            }
            .site-logo { font-size: 1.5em; }

            .gallery-controls {
                flex-direction: column;
                align-items: stretch;
            }
            .search-bar input[type="text"], .filter-sort select {
                width: 100%;
            }

            .modal-content {
                margin: 10% auto;
                width: 95%;
                padding: 20px;
            }
             .modal-content.modal-lg {
                max-width: 95%;
            }

            .recipe-grid {
                grid-template-columns: 1fr; /* Single column on small screens */
            }
            .newsletter-form input[type="email"] { width: calc(100% - 100px); margin-bottom: 10px;}
            .newsletter-form button { width: auto;}
        }
        
        @media (max-width: 480px) {
            body { font-size: 15px; }
            h1 { font-size: 2em; }
            h2 { font-size: 1.6em; }
            h3 { font-size: 1.3em; }
            .recipe-card-content h3 { font-size: 1.2em; }
            button, input[type="submit"] { padding: 10px 15px; font-size: 0.95em;}
            .footer { padding: 20px 10px; }
        }

    </style>
</head>
<body>

    <header class="navbar">
        <div class="navbar-container">
            <div class="site-logo"><a href="#" id="home-link">Sweet & Savory</a></div>
            <button class="menu-toggle" id="menu-toggle-btn" aria-label="Toggle navigation menu">&#9776;</button>
            <nav>
                <ul class="nav-links" id="nav-links-list">
                    <li><a href="#" id="nav-home">Home</a></li>
                    <li><a href="#" id="nav-add-recipe">Add Recipe</a></li>
                    </ul>
            </nav>
             <button class="profile-icon" id="profile-btn" aria-label="User Profile">&#128100;</button>
        </div>
    </header>

    <main>
        <div class="container">
            <section id="recipe-gallery-section">
                <div class="gallery-controls">
                    <div class="search-bar">
                        <input type="text" id="search-input" placeholder="Search recipes by title or tag...">
                    </div>
                    <div class="filter-sort">
                        <select id="sort-filter">
                            <option value="newest">Sort by Newest</option>
                            <option value="most-liked">Sort by Most Liked</option>
                        </select>
                    </div>
                </div>
                <div id="recipe-grid" class="recipe-grid">
                    <p id="no-recipes-message" class="hidden">No recipes found. Try adding one!</p>
                </div>
            </section>
        </div>
    </main>

    <div id="add-edit-recipe-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="close-add-edit-modal">&times;</span>
            <div class="modal-header">
                <h2 id="add-edit-modal-title">Add New Recipe</h2>
            </div>
            <form id="add-edit-recipe-form">
                <input type="hidden" id="recipe-id-input"> <div class="form-group">
                    <label for="recipe-title">Recipe Title</label>
                    <input type="text" id="recipe-title" required>
                </div>
                <div class="form-group">
                    <label for="recipe-short-description">Short Description</label>
                    <textarea id="recipe-short-description" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label for="recipe-image">Image (URL or Upload)</label>
                    <input type="url" id="recipe-image-url" placeholder="Enter image URL (e.g., https://example.com/image.jpg)">
                    <p style="text-align: center; margin: 5px 0; font-size: 0.9em;">OR</p>
                    <input type="file" id="recipe-image-upload" accept="image/*">
                    <img id="image-preview" src="#" alt="Image Preview">
                </div>
                <div class="form-group">
                    <label for="recipe-ingredients">Ingredients (one per line)</label>
                    <textarea id="recipe-ingredients" rows="5" required placeholder="e.g.,&#10;1 cup flour&#10;2 eggs&#10;100g chocolate"></textarea>
                </div>
                <div class="form-group">
                    <label for="recipe-instructions">Step-by-step Instructions</label>
                    <textarea id="recipe-instructions" rows="7" required></textarea>
                </div>
                <div class="form-group">
                    <label for="recipe-tags">Tags (comma-separated)</label>
                    <input type="text" id="recipe-tags" placeholder="e.g., dessert, vegan, quick">
                </div>
                <button type="submit" id="submit-recipe-btn">Save Recipe</button>
            </form>
        </div>
    </div>

    <div id="recipe-detail-modal" class="modal">
        <div class="modal-content modal-lg">
            <span class="close-btn" id="close-recipe-detail-modal">&times;</span>
            <div id="recipe-detail-content">
                </div>
             <div class="comments-section">
                <h3>Comments</h3>
                <div id="comments-list">
                    </div>
                <form id="add-comment-form" class="mt-1">
                    <h4>Leave a Comment</h4>
                    <input type="hidden" id="comment-recipe-id">
                    <textarea id="comment-text" placeholder="Write your comment..." rows="3" required></textarea>
                    <button type="submit">Post Comment</button>
                </form>
            </div>
        </div>
    </div>
    
    <div id="user-profile-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="close-profile-modal">&times;</span>
            <div class="modal-header">
                <h2>User Profile</h2>
            </div>
            <form id="user-profile-form">
                <div class="form-group">
                    <label for="display-name">Display Name</label>
                    <input type="text" id="display-name" placeholder="Enter your name for comments" required>
                </div>
                <button type="submit">Save Profile</button>
            </form>
            <p id="profile-message" class="mt-1"></p>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <div class="social-media-placeholders">
                <a href="#" aria-label="Facebook">F</a> <a href="#" aria-label="Instagram">I</a> <a href="#" aria-label="Pinterest">P</a> </div>
            <div class="newsletter-form mt-1">
                <input type="email" id="newsletter-email" placeholder="Your email for newsletter">
                <button id="newsletter-submit-btn">Subscribe</button>
            </div>
            <p class="mt-1">&copy; <span id="current-year"></span> Sweet & Savory Corner. All Rights Reserved.</p>
        </div>
    </footer>

    <button id="scroll-to-top" title="Go to top">&#8679;</button>

    <svg width="0" height="0" style="position:absolute;">
      <symbol id="icon-heart" viewBox="0 0 24 24">
        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
      </symbol>
    </svg>


<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Elements ---
        const recipeGrid = document.getElementById('recipe-grid');
        const noRecipesMessage = document.getElementById('no-recipes-message');
        const searchInput = document.getElementById('search-input');
        const sortFilter = document.getElementById('sort-filter');

        // Nav
        const navHomeLink = document.getElementById('nav-home');
        const navAddRecipeLink = document.getElementById('nav-add-recipe');
        const menuToggleBtn = document.getElementById('menu-toggle-btn');
        const navLinksList = document.getElementById('nav-links-list');
        const homeLinkLogo = document.getElementById('home-link');


        // Add/Edit Recipe Modal
        const addEditRecipeModal = document.getElementById('add-edit-recipe-modal');
        const closeAddEditModalBtn = document.getElementById('close-add-edit-modal');
        const addEditRecipeForm = document.getElementById('add-edit-recipe-form');
        const addEditModalTitle = document.getElementById('add-edit-modal-title');
        const recipeIdInput = document.getElementById('recipe-id-input');
        const recipeTitleInput = document.getElementById('recipe-title');
        const recipeShortDescriptionInput = document.getElementById('recipe-short-description');
        const recipeImageURLInput = document.getElementById('recipe-image-url');
        const recipeImageUploadInput = document.getElementById('recipe-image-upload');
        const imagePreview = document.getElementById('image-preview');
        const recipeIngredientsInput = document.getElementById('recipe-ingredients');
        const recipeInstructionsInput = document.getElementById('recipe-instructions');
        const recipeTagsInput = document.getElementById('recipe-tags');
        const submitRecipeBtn = document.getElementById('submit-recipe-btn');

        // Recipe Detail Modal
        const recipeDetailModal = document.getElementById('recipe-detail-modal');
        const closeRecipeDetailModalBtn = document.getElementById('close-recipe-detail-modal');
        const recipeDetailContent = document.getElementById('recipe-detail-content');
        
        // Comments
        const commentsList = document.getElementById('comments-list');
        const addCommentForm = document.getElementById('add-comment-form');
        const commentRecipeIdInput = document.getElementById('comment-recipe-id');
        const commentTextInput = document.getElementById('comment-text');

        // User Profile Modal
        const profileBtn = document.getElementById('profile-btn');
        const userProfileModal = document.getElementById('user-profile-modal');
        const closeProfileModalBtn = document.getElementById('close-profile-modal');
        const userProfileForm = document.getElementById('user-profile-form');
        const displayNameInput = document.getElementById('display-name');
        const profileMessage = document.getElementById('profile-message');

        // Footer
        const currentYearSpan = document.getElementById('current-year');
        const newsletterEmailInput = document.getElementById('newsletter-email');
        const newsletterSubmitBtn = document.getElementById('newsletter-submit-btn');
        
        // Scroll-to-top
        const scrollToTopBtn = document.getElementById('scroll-to-top');

        // --- State Management (localStorage) ---
        let recipes = JSON.parse(localStorage.getItem('recipes')) || [];
        let comments = JSON.parse(localStorage.getItem('commentsDB')) || []; // Renamed to avoid conflict
        let userProfile = JSON.parse(localStorage.getItem('userProfile')) || { displayName: 'Guest' };
        let likedRecipesByUser = JSON.parse(localStorage.getItem('likedRecipesByUser')) || {}; // { recipeId: true }

        // --- Helper Functions ---
        const generateId = () => '_' + Math.random().toString(36).substr(2, 9);

        const saveRecipes = () => localStorage.setItem('recipes', JSON.stringify(recipes));
        const saveComments = () => localStorage.setItem('commentsDB', JSON.stringify(comments));
        const saveUserProfile = () => localStorage.setItem('userProfile', JSON.stringify(userProfile));
        const saveLikedRecipes = () => localStorage.setItem('likedRecipesByUser', JSON.stringify(likedRecipesByUser));

        const getFileBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        };

        // --- Navigation ---
        menuToggleBtn.addEventListener('click', () => {
            navLinksList.classList.toggle('active');
        });
        
        const closeAllModals = () => {
            addEditRecipeModal.style.display = 'none';
            recipeDetailModal.style.display = 'none';
            userProfileModal.style.display = 'none';
        };
        
        // Close modals with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === "Escape") {
                closeAllModals();
            }
        });

        // Close modals by clicking outside
        window.onclick = function(event) {
            if (event.target == addEditRecipeModal) addEditRecipeModal.style.display = "none";
            if (event.target == recipeDetailModal) recipeDetailModal.style.display = "none";
            if (event.target == userProfileModal) userProfileModal.style.display = "none";
        }

        navHomeLink.addEventListener('click', (e) => {
            e.preventDefault();
            closeAllModals();
            navLinksList.classList.remove('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });
            renderRecipeGallery(); // Refresh gallery
        });
        homeLinkLogo.addEventListener('click', (e) => {
            e.preventDefault();
            navHomeLink.click();
        });


        // --- Recipe Gallery Rendering ---
        const renderRecipeCard = (recipe) => {
            const card = document.createElement('article');
            card.className = 'recipe-card';
            card.dataset.id = recipe.id;

            const isLiked = likedRecipesByUser[recipe.id];
            
            // Use placeholder if image is missing or invalid
            let imageSrc = recipe.image || 'https://via.placeholder.com/300x200/FFE4E1/FF69B4?text=Recipe+Image';
            if (recipe.image && !recipe.image.startsWith('http') && !recipe.image.startsWith('data:image')) {
                 imageSrc = 'https://via.placeholder.com/300x200/FFE4E1/FF69B4?text=Image+Error';
            }


            card.innerHTML = `
                <img src="${imageSrc}" alt="${recipe.title}" class="recipe-card-image">
                <div class="recipe-card-content">
                    <h3>${recipe.title}</h3>
                    <p>${recipe.shortDescription}</p>
                    <div class="recipe-card-meta">
                        <span class="likes ${isLiked ? 'liked' : ''}" data-recipe-id="${recipe.id}" title="Like this recipe">
                            <svg><use xlink:href="#icon-heart"></use></svg>
                            <span class="like-count">${recipe.likes || 0}</span> Likes
                        </span>
                        <span>${recipe.tags ? recipe.tags.map(t => `#${t}`).join(' ') : ''}</span>
                    </div>
                    <button class="view-full-btn" data-id="${recipe.id}">View Full Recipe</button>
                </div>
            `;
            card.querySelector('.view-full-btn').addEventListener('click', () => showRecipeDetail(recipe.id));
            card.querySelector('.likes').addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent card click event if any
                toggleLike(recipe.id, true); // true to re-render gallery for card update
            });
            return card;
        };

        const renderRecipeGallery = () => {
            recipeGrid.innerHTML = '';
            const searchTerm = searchInput.value.toLowerCase();
            const currentSort = sortFilter.value;

            let filteredRecipes = recipes.filter(recipe => {
                const titleMatch = recipe.title.toLowerCase().includes(searchTerm);
                const tagMatch = recipe.tags && recipe.tags.some(tag => tag.toLowerCase().includes(searchTerm));
                return titleMatch || tagMatch;
            });

            if (currentSort === 'most-liked') {
                filteredRecipes.sort((a, b) => (b.likes || 0) - (a.likes || 0));
            } else { // newest (default)
                filteredRecipes.sort((a, b) => b.timestamp - a.timestamp);
            }

            if (filteredRecipes.length === 0) {
                noRecipesMessage.classList.remove('hidden');
            } else {
                noRecipesMessage.classList.add('hidden');
                filteredRecipes.forEach(recipe => {
                    recipeGrid.appendChild(renderRecipeCard(recipe));
                });
            }
        };

        searchInput.addEventListener('input', renderRecipeGallery);
        sortFilter.addEventListener('change', renderRecipeGallery);

        // --- Add/Edit Recipe Functionality ---
        navAddRecipeLink.addEventListener('click', (e) => {
            e.preventDefault();
            addEditModalTitle.textContent = 'Add New Recipe';
            addEditRecipeForm.reset();
            recipeIdInput.value = '';
            imagePreview.style.display = 'none';
            imagePreview.src = '#';
            submitRecipeBtn.textContent = 'Add Recipe';
            closeAllModals();
            addEditRecipeModal.style.display = 'block';
            navLinksList.classList.remove('active');
        });

        closeAddEditModalBtn.onclick = () => addEditRecipeModal.style.display = 'none';

        recipeImageUploadInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                const file = this.files[0];
                getFileBase64(file).then(base64 => {
                    imagePreview.src = base64;
                    imagePreview.style.display = 'block';
                    recipeImageURLInput.value = ''; // Clear URL if file is chosen
                }).catch(err => {
                    console.error("Error reading file for preview:", err);
                    alert("Could not preview image. Please try another file or use a URL.");
                    imagePreview.style.display = 'none';
                });
            } else {
                imagePreview.style.display = 'none';
            }
        });
        
        recipeImageURLInput.addEventListener('input', function() {
             if (this.value) {
                imagePreview.src = this.value;
                imagePreview.style.display = 'block';
                recipeImageUploadInput.value = ''; // Clear file input
            } else if (!recipeImageUploadInput.files[0]) {
                 imagePreview.style.display = 'none';
            }
        });


        addEditRecipeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = recipeIdInput.value || generateId();
            let imageValue = recipeImageURLInput.value;

            if (recipeImageUploadInput.files && recipeImageUploadInput.files[0]) {
                try {
                    imageValue = await getFileBase64(recipeImageUploadInput.files[0]);
                } catch (error) {
                    console.error("Error converting image to Base64:", error);
                    alert("Error processing image. Please try again or use an image URL.");
                    return;
                }
            } else if (!imageValue && !recipeIdInput.value) { // No image URL and no file upload for new recipe
                 imageValue = ''; // Allow no image
            } else if (!imageValue && recipeIdInput.value) { // Editing and URL cleared, keep existing
                const existingRecipe = recipes.find(r => r.id === id);
                if (existingRecipe) imageValue = existingRecipe.image;
            }


            const newRecipeData = {
                id: id,
                title: recipeTitleInput.value.trim(),
                shortDescription: recipeShortDescriptionInput.value.trim(),
                image: imageValue,
                ingredients: recipeIngredientsInput.value.trim().split('\n').filter(Boolean),
                instructions: recipeInstructionsInput.value.trim(),
                tags: recipeTagsInput.value.split(',').map(tag => tag.trim()).filter(Boolean),
                timestamp: recipeIdInput.value ? recipes.find(r => r.id === id).timestamp : Date.now(),
                likes: recipeIdInput.value ? recipes.find(r => r.id === id).likes || 0 : 0,
            };
            
            if (recipeIdInput.value) { // Editing existing recipe
                const index = recipes.findIndex(r => r.id === id);
                if (index !== -1) {
                    recipes[index] = { ...recipes[index], ...newRecipeData }; // Preserve original likes and timestamp if not updated by form
                }
            } else { // Adding new recipe
                recipes.push(newRecipeData);
            }

            saveRecipes();
            renderRecipeGallery();
            addEditRecipeModal.style.display = 'none';
        });

        const openEditRecipeForm = (recipeId) => {
            const recipe = recipes.find(r => r.id === recipeId);
            if (!recipe) return;

            addEditModalTitle.textContent = 'Edit Recipe';
            recipeIdInput.value = recipe.id;
            recipeTitleInput.value = recipe.title;
            recipeShortDescriptionInput.value = recipe.shortDescription;
            
            if (recipe.image && recipe.image.startsWith('data:image')) { // Base64
                imagePreview.src = recipe.image;
                imagePreview.style.display = 'block';
                recipeImageURLInput.value = '';
                recipeImageUploadInput.value = '';
            } else if (recipe.image) { // URL
                recipeImageURLInput.value = recipe.image;
                imagePreview.src = recipe.image;
                imagePreview.style.display = 'block';
                recipeImageUploadInput.value = '';
            } else {
                imagePreview.style.display = 'none';
                imagePreview.src = '#';
                recipeImageURLInput.value = '';
                 recipeImageUploadInput.value = '';
            }

            recipeIngredientsInput.value = recipe.ingredients.join('\n');
            recipeInstructionsInput.value = recipe.instructions;
            recipeTagsInput.value = recipe.tags.join(', ');
            submitRecipeBtn.textContent = 'Save Changes';
            
            closeAllModals();
            addEditRecipeModal.style.display = 'block';
        };
        
        const deleteRecipe = (recipeId) => {
            if (!confirm('Are you sure you want to delete this recipe? This will also delete its comments and likes.')) return;

            recipes = recipes.filter(r => r.id !== recipeId);
            comments = comments.filter(c => c.recipeId !== recipeId); // Delete associated comments
            delete likedRecipesByUser[recipeId]; // Remove from liked list

            saveRecipes();
            saveComments();
            saveLikedRecipes();
            renderRecipeGallery();
            recipeDetailModal.style.display = 'none'; // Close detail view if open
        };

        // --- Recipe Detail View ---
        closeRecipeDetailModalBtn.onclick = () => recipeDetailModal.style.display = 'none';

        const showRecipeDetail = (recipeId) => {
            const recipe = recipes.find(r => r.id === recipeId);
            if (!recipe) return;

            commentRecipeIdInput.value = recipeId; // Set for new comment form
            const isLiked = likedRecipesByUser[recipe.id];
            let imageDetailSrc = recipe.image || 'https://via.placeholder.com/600x400/FFE4E1/FF69B4?text=Recipe+Image';
             if (recipe.image && !recipe.image.startsWith('http') && !recipe.image.startsWith('data:image')) {
                 imageDetailSrc = 'https://via.placeholder.com/600x400/FFE4E1/FF69B4?text=Image+Error';
            }

            recipeDetailContent.innerHTML = `
                <img src="${imageDetailSrc}" alt="${recipe.title}" class="recipe-detail-media">
                <h2>${recipe.title}</h2>
                <p>${recipe.shortDescription}</p>
                
                <h4>Ingredients:</h4>
                <ul>${recipe.ingredients.map(ing => `<li>${ing}</li>`).join('')}</ul>
                
                <h4>Instructions:</h4>
                <div class="instructions-text">${recipe.instructions.replace(/\n/g, '<br>')}</div>
                
                <p><strong>Tags:</strong> ${recipe.tags ? recipe.tags.map(t => `#${t}`).join(' ') : 'None'}</p>
                <p><strong>Likes:</strong> <span id="detail-like-count">${recipe.likes || 0}</span></p>

                <div class="recipe-detail-actions">
                    <button class="like-btn ${isLiked ? 'liked' : ''}" id="detail-like-btn" data-recipe-id="${recipe.id}">
                        <svg><use xlink:href="#icon-heart"></use></svg> ${isLiked ? 'Liked' : 'Like'}
                    </button>
                    <button id="edit-recipe-btn" data-id="${recipe.id}">Edit Recipe</button>
                    <button id="delete-recipe-btn" data-id="${recipe.id}" style="background-color: #DC143C;">Delete Recipe</button>
                </div>
            `;
            
            document.getElementById('detail-like-btn').addEventListener('click', function() {
                toggleLike(recipe.id, false); // false, don't re-render whole gallery
                // Update button text and style locally for immediate feedback
                const currentRecipe = recipes.find(r => r.id === recipe.id); // Get updated recipe
                this.classList.toggle('liked', likedRecipesByUser[recipe.id]);
                this.innerHTML = `<svg><use xlink:href="#icon-heart"></use></svg> ${likedRecipesByUser[recipe.id] ? 'Liked' : 'Like'}`;
                document.getElementById('detail-like-count').textContent = currentRecipe.likes || 0;
            });
            document.getElementById('edit-recipe-btn').addEventListener('click', () => openEditRecipeForm(recipe.id));
            document.getElementById('delete-recipe-btn').addEventListener('click', () => deleteRecipe(recipe.id));
            
            renderComments(recipeId);
            closeAllModals();
            recipeDetailModal.style.display = 'block';
        };
        
        // --- Like System ---
        const toggleLike = (recipeId, updateGallery = false) => {
            const recipe = recipes.find(r => r.id === recipeId);
            if (!recipe) return;

            if (likedRecipesByUser[recipeId]) {
                recipe.likes = (recipe.likes || 0) - 1;
                delete likedRecipesByUser[recipeId];
            } else {
                recipe.likes = (recipe.likes || 0) + 1;
                likedRecipesByUser[recipeId] = true;
            }
            if (recipe.likes < 0) recipe.likes = 0; // Ensure likes don't go negative

            saveRecipes();
            saveLikedRecipes();

            if (updateGallery) {
                renderRecipeGallery(); // Re-render gallery to update card
            } else { // Update only detail view if open
                const detailLikeCount = document.getElementById('detail-like-count');
                if (detailLikeCount && recipeDetailModal.style.display === 'block') {
                    detailLikeCount.textContent = recipe.likes;
                }
                 const detailLikeBtn = document.getElementById('detail-like-btn');
                 if(detailLikeBtn && detailLikeBtn.dataset.recipeId === recipeId) {
                    detailLikeBtn.classList.toggle('liked', likedRecipesByUser[recipeId]);
                    detailLikeBtn.innerHTML = `<svg><use xlink:href="#icon-heart"></use></svg> ${likedRecipesByUser[recipeId] ? 'Liked' : 'Like'}`;
                 }
            }
        };


        // --- Comment System ---
        const renderComments = (recipeId) => {
            commentsList.innerHTML = '';
            const recipeComments = comments.filter(c => c.recipeId === recipeId && !c.parentId)
                                         .sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));

            if (recipeComments.length === 0) {
                commentsList.innerHTML = '<p>No comments yet. Be the first to comment!</p>';
            } else {
                recipeComments.forEach(comment => {
                    commentsList.appendChild(createCommentElement(comment, recipeId));
                });
            }
        };

        const createCommentElement = (comment, recipeId, isReply = false) => {
            const div = document.createElement('div');
            div.className = `comment ${isReply ? 'reply' : ''}`;
            div.dataset.commentId = comment.id;

            const replies = comments.filter(r => r.parentId === comment.id)
                                    .sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));

            div.innerHTML = `
                <div class="comment-header">
                    <span class="comment-author">${comment.authorName || 'Anonymous'}</span>
                    <span class="comment-date">${new Date(comment.timestamp).toLocaleString()}</span>
                </div>
                <p class="comment-body">${comment.text.replace(/\n/g, '<br>')}</p>
                <div class="comment-actions">
                    ${!isReply ? '<button class="reply-to-comment-btn">Reply</button>' : ''}
                    ${comment.authorName === userProfile.displayName ? `
                        <button class="edit-comment-btn">Edit</button>
                        <button class="delete-comment-btn">Delete</button>
                    ` : ''}
                </div>
                ${!isReply ? '<div class="reply-form-container hidden"></div>' : ''}
                <div class="replies">
                    ${replies.map(reply => createCommentElement(reply, recipeId, true).outerHTML).join('')}
                </div>
            `;

            if (!isReply) {
                const replyBtn = div.querySelector('.reply-to-comment-btn');
                if (replyBtn) {
                    replyBtn.addEventListener('click', () => toggleReplyForm(comment.id, div.querySelector('.reply-form-container')));
                }
            }
            
            const editBtn = div.querySelector('.edit-comment-btn');
            if (editBtn) editBtn.addEventListener('click', () => showEditCommentForm(comment.id, div));
            
            const deleteBtn = div.querySelector('.delete-comment-btn');
            if (deleteBtn) deleteBtn.addEventListener('click', () => deleteComment(comment.id, recipeId));

            return div;
        };

        const toggleReplyForm = (parentId, container) => {
            if (container.classList.contains('hidden')) {
                container.classList.remove('hidden');
                container.innerHTML = `
                    <form class="reply-form">
                        <textarea placeholder="Write your reply..." rows="2" required></textarea>
                        <button type="submit">Post Reply</button>
                        <button type="button" class="cancel-reply-btn">Cancel</button>
                    </form>
                `;
                container.querySelector('.reply-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const text = e.target.querySelector('textarea').value.trim();
                    if (text) {
                        handleCommentSubmit(commentRecipeIdInput.value, text, parentId);
                        container.classList.add('hidden'); // Hide form after submitting
                        container.innerHTML = ''; // Clear form
                    }
                });
                container.querySelector('.cancel-reply-btn').addEventListener('click', () => {
                     container.classList.add('hidden');
                     container.innerHTML = '';
                });
            } else {
                container.classList.add('hidden');
                container.innerHTML = '';
            }
        };
        
        const showEditCommentForm = (commentId, commentElement) => {
            const comment = comments.find(c => c.id === commentId);
            if (!comment) return;

            const commentBody = commentElement.querySelector('.comment-body');
            const commentActions = commentElement.querySelector('.comment-actions');
            
            const originalText = comment.text;
            commentBody.innerHTML = `
                <form class="edit-comment-form">
                    <textarea rows="3">${originalText}</textarea>
                    <button type="submit">Save</button>
                    <button type="button" class="cancel-edit-btn">Cancel</button>
                </form>
            `;
            commentActions.classList.add('hidden'); // Hide actions while editing

            const editForm = commentBody.querySelector('.edit-comment-form');
            editForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newText = editForm.querySelector('textarea').value.trim();
                if (newText && newText !== originalText) {
                    comment.text = newText;
                    saveComments();
                    renderComments(comment.recipeId); // Re-render all comments for simplicity
                } else { // If no change or empty, revert
                    commentBody.innerHTML = originalText.replace(/\n/g, '<br>');
                    commentActions.classList.remove('hidden');
                }
            });
            editForm.querySelector('.cancel-edit-btn').addEventListener('click', () => {
                commentBody.innerHTML = originalText.replace(/\n/g, '<br>');
                commentActions.classList.remove('hidden');
            });
        };

        const deleteComment = (commentId, recipeId) => {
            if (!confirm('Are you sure you want to delete this comment? If it has replies, they will also be deleted.')) return;
            
            // Find and remove the comment and its direct replies
            const commentIndex = comments.findIndex(c => c.id === commentId);
            if (commentIndex > -1) {
                comments.splice(commentIndex, 1); // Remove parent comment
                // Remove replies to this comment
                comments = comments.filter(reply => reply.parentId !== commentId);
                saveComments();
                renderComments(recipeId);
            }
        };

        const handleCommentSubmit = (recipeId, text, parentId = null) => {
            const newComment = {
                id: generateId(),
                recipeId: recipeId,
                parentId: parentId,
                text: text,
                authorName: userProfile.displayName || 'Anonymous',
                timestamp: new Date().toISOString()
            };
            comments.push(newComment);
            saveComments();
            renderComments(recipeId);
            if (!parentId) { // If not a reply, clear main comment form
                commentTextInput.value = '';
            }
        };
        
        addCommentForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const recipeId = commentRecipeIdInput.value;
            const text = commentTextInput.value.trim();
            if (text && recipeId) {
                handleCommentSubmit(recipeId, text);
            }
        });


        // --- User Profile Modal ---
        profileBtn.addEventListener('click', () => {
            displayNameInput.value = userProfile.displayName === 'Guest' ? '' : userProfile.displayName;
            profileMessage.textContent = '';
            closeAllModals();
            userProfileModal.style.display = 'block';
        });
        closeProfileModalBtn.onclick = () => userProfileModal.style.display = 'none';

        userProfileForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const newName = displayNameInput.value.trim();
            if (newName) {
                userProfile.displayName = newName;
                saveUserProfile();
                profileMessage.textContent = 'Profile saved successfully!';
                profileMessage.style.color = 'green';
                setTimeout(() => {
                     userProfileModal.style.display = 'none';
                     // Re-render comments if a recipe detail view is open, to update author names
                     if(recipeDetailModal.style.display === 'block' && commentRecipeIdInput.value) {
                        renderComments(commentRecipeIdInput.value);
                     }
                }, 1500);
            } else {
                profileMessage.textContent = 'Display name cannot be empty.';
                 profileMessage.style.color = 'red';
            }
        });

        // --- Footer ---
        currentYearSpan.textContent = new Date().getFullYear();
        newsletterSubmitBtn.addEventListener('click', (e) => {
            e.preventDefault();
            const email = newsletterEmailInput.value.trim();
            if(email && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { // Basic email validation
                alert(`Thank you for subscribing with ${email}! (This is a demo)`);
                localStorage.setItem('newsletterSub', email); // Demo storage
                newsletterEmailInput.value = '';
            } else {
                alert('Please enter a valid email address.');
            }
        });

        // --- Scroll-to-top Button ---
        window.onscroll = () => {
            if (document.body.scrollTop > 100 || document.documentElement.scrollTop > 100) {
                scrollToTopBtn.style.display = "flex";
            } else {
                scrollToTopBtn.style.display = "none";
            }
        };
        scrollToTopBtn.addEventListener('click', () => {
            window.scrollTo({top: 0, behavior: 'smooth'});
        });


        // --- Initial Load ---
        renderRecipeGallery();
        if (recipes.length === 0) { // Populate with a few dummy recipes if empty for demonstration
            recipes = [
                { id: generateId(), title: "Pastel Pink Macarons", shortDescription: "Delicate and delicious French macarons with a hint of rose.", image: "https://images.pexels.com/photos/372882/pexels-photo-372882.jpeg?auto=compress&cs=tinysrgb&w=400&h=300&dpr=1", ingredients: ["100g almond flour", "100g powdered sugar", "70g egg whites", "70g granulated sugar", "Rose extract", "Pink food coloring"], instructions: "1. Sift almond flour and powdered sugar. 2. Make Italian meringue with egg whites and granulated sugar. 3. Fold in dry ingredients (macaronage). 4. Pipe and bake.", tags: ["dessert", "baking", "french"], timestamp: Date.now() - 100000, likes: 15 },
                { id: generateId(), title: "Lavender Infused Cupcakes", shortDescription: "Soft cupcakes infused with calming lavender, topped with a light buttercream.", image: "https://images.pexels.com/photos/1055272/pexels-photo-1055272.jpeg?auto=compress&cs=tinysrgb&w=400&h=300&dpr=1", ingredients: ["1 cup flour", "1/2 cup sugar", "1 tsp baking powder", "1 egg", "1/4 cup milk", "Dried lavender", "Buttercream frosting"], instructions: "1. Preheat oven. Mix dry ingredients. 2. Add wet ingredients. 3. Infuse milk with lavender. 4. Bake and frost.", tags: ["cupcake", "lavender", "sweet"], timestamp: Date.now() - 200000, likes: 22 },
                { id: generateId(), title: "Mint & Pea Bruschetta", shortDescription: "A refreshing and light appetizer, perfect for spring gatherings.", image: "https://images.pexels.com/photos/5638645/pexels-photo-5638645.jpeg?auto=compress&cs=tinysrgb&w=400&h=300&dpr=1", ingredients: ["Fresh peas", "Mint leaves", "Ricotta cheese", "Baguette slices", "Olive oil", "Lemon zest"], instructions: "1. Blanch peas. 2. Mash peas with mint and ricotta. 3. Toast baguette slices. 4. Top with pea mixture and lemon zest.", tags: ["appetizer", "vegan", "spring"], timestamp: Date.now() - 50000, likes: 8 }
            ];
            saveRecipes();
            renderRecipeGallery();
        }


    }); // End DOMContentLoaded
</script>

</body>
</html>
